





<!DOCTYPE html>
<html
  lang="en"
  dir="ltr"
  class="scroll-smooth"
  data-default-appearance="dark"
  data-auto-appearance="true"
><head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="theme-color" content="rgb(255,255,255)" />
  
  <title>End User Auth and Authz with OpenShift Service Mesh and Keycloak &middot; Tech Chronicles...</title>
    <meta name="title" content="End User Auth and Authz with OpenShift Service Mesh and Keycloak &middot; Tech Chronicles..." />
  
  
  
  
  
  <script
    type="text/javascript"
    src="/js/appearance.min.022d0ebc3b46a335eb1c7ef79b7f2de143d7cd5156d433638592ef1ce5f8554e.js"
    integrity="sha256-Ai0OvDtGozXrHH73m38t4UPXzVFW1DNjhZLvHOX4VU4="
  ></script>
  
  
  
  
  
  
  
  
  <link
    type="text/css"
    rel="stylesheet"
    href="/css/main.bundle.min.2dd44849efa9d0ef68e8cdede2901f86dec79026811f5cf6b25aa2b8cd8ee63e.css"
    integrity="sha256-LdRISe&#43;p0O9o6M3t4pAfht7HkCaBH1z2slqiuM2O5j4="
  />
  
  
    
    
  
  
  
    
    <script
      defer
      type="text/javascript"
      id="script-bundle"
      src="/js/main.bundle.min.3e80d0528c59616e7de9b0ca9316d9afd314b49ed9e5e6b88873731486ad67ee.js"
      integrity="sha256-PoDQUoxZYW596bDKkxbZr9MUtJ7Z5ea4iHNzFIatZ&#43;4="
      data-copy="Copy"
      data-copied="Copied"
    ></script>
  
  
  <meta
    name="description"
    content="
      End User Authentication and Authorization with OpenShift Service Mesh and Keycloak
    "
  />
  
  
  
  <link rel="canonical" href="https://vikaspogu.dev/blog/servicemesh-jwt-auth-authz-keycloack/" />
  
  
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png" />
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png" />
    <link rel="manifest" href="/site.webmanifest" />
  
  
  
  
  
  
  
  <meta property="og:title" content="End User Auth and Authz with OpenShift Service Mesh and Keycloak" />
<meta property="og:description" content="End User Authentication and Authorization with OpenShift Service Mesh and Keycloak" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://vikaspogu.dev/blog/servicemesh-jwt-auth-authz-keycloack/" /><meta property="article:section" content="blog" />
<meta property="article:published_time" content="2020-11-12T00:00:00+00:00" />
<meta property="article:modified_time" content="2020-11-12T00:00:00+00:00" />


  <meta name="twitter:card" content="summary"/><meta name="twitter:title" content="End User Auth and Authz with OpenShift Service Mesh and Keycloak"/>
<meta name="twitter:description" content="End User Authentication and Authorization with OpenShift Service Mesh and Keycloak"/>

  
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "Article",
    "articleSection": "Blogs",
    "name": "End User Auth and Authz with OpenShift Service Mesh and Keycloak",
    "headline": "End User Auth and Authz with OpenShift Service Mesh and Keycloak",
    "description": "End User Authentication and Authorization with OpenShift Service Mesh and Keycloak",
    "abstract": "In this article, I will share the setup for enabling Authentication and Authorization in OpenShift Service Mesh with Keycloak.",
    "inLanguage": "en",
    "url" : "https:\/\/vikaspogu.dev\/blog\/servicemesh-jwt-auth-authz-keycloack\/",
    "author" : {
      "@type": "Person",
      "name": "Vikas Pogu"
    },
    "copyrightYear": "2020",
    "dateCreated": "2020-11-12T00:00:00\u002b00:00",
    "datePublished": "2020-11-12T00:00:00\u002b00:00",
    
    "dateModified": "2020-11-12T00:00:00\u002b00:00",
    
    "keywords": ["istio","service mesh","keycloak","jwt","authentication","authorization"],
    
    "mainEntityOfPage": "true",
    "wordCount": "979"
  }
  </script>


  
  <meta name="author" content="Vikas Pogu" />
  
  
  






  
  
  
  
  

  
  
</head>
<body
    class="flex flex-col h-screen px-6 m-auto text-lg leading-7 max-w-7xl bg-neutral text-neutral-900 dark:bg-neutral-800 dark:text-neutral sm:px-14 md:px-24 lg:px-32"
  >
    <div id="the-top" class="absolute flex self-center">
      <a
        class="px-3 py-1 text-sm -translate-y-8 rounded-b-lg bg-primary-200 focus:translate-y-0 dark:bg-neutral-600"
        href="#main-content"
        ><span class="font-bold pe-2 text-primary-600 dark:text-primary-400">&darr;</span
        >Skip to main content</a
      >
    </div>
    
    
      <header class="py-6 font-semibold text-neutral-900 dark:text-neutral print:hidden sm:py-10">
  <nav class="flex items-start justify-between sm:items-center">
    
    <div class="flex flex-row items-center">
      
  <a
    class="decoration-primary-500 hover:underline hover:decoration-2 hover:underline-offset-2"
    rel="me"
    href="/"
    >Tech Chronicles&hellip;</a
  >

    </div>
    
    
      <ul class="flex flex-col list-none text-end sm:flex-row">
        
          
            
            <li class="group mb-1 sm:mb-0 sm:me-7 sm:last:me-0.5">
              
                <a
                  href="/blog/"
                  title="Blogs"
                  
                  ><span
                      class="decoration-primary-500 group-hover:underline group-hover:decoration-2 group-hover:underline-offset-2"
                      >Blogs</span
                    >
                  </a
                >
              
            </li>
          
            
            <li class="group mb-1 sm:mb-0 sm:me-7 sm:last:me-0.5">
              
                <a
                  href="/about/"
                  title="About"
                  
                  ><span
                      class="decoration-primary-500 group-hover:underline group-hover:decoration-2 group-hover:underline-offset-2"
                      >About me</span
                    >
                  </a
                >
              
            </li>
          
            
            <li class="group mb-1 sm:mb-0 sm:me-7 sm:last:me-0.5">
              
                <a
                  href="/tags/"
                  title="Tags"
                  
                  ><span
                      class="decoration-primary-500 group-hover:underline group-hover:decoration-2 group-hover:underline-offset-2"
                      >Tags</span
                    >
                  </a
                >
              
            </li>
          
            
            <li class="group mb-1 sm:mb-0 sm:me-7 sm:last:me-0.5">
              
                
                
              
            </li>
          
            
              
          
        
      </ul>
    
  </nav>
</header>

    
    <div class="relative flex flex-col grow">
      <main id="main-content" class="grow">
        
  <article>
    <header class="max-w-prose">
      
      <h1 class="mt-0 text-4xl font-extrabold text-neutral-900 dark:text-neutral">
        End User Auth and Authz with OpenShift Service Mesh and Keycloak
      </h1>
      <div class="mt-8 mb-12 text-base text-neutral-500 dark:text-neutral-400 print:hidden">
        





  
  



  

  
  
    
  

  

  

  
    
  

  


  <div class="flex flex-row flex-wrap items-center">
    
    
      <time datetime="2020-11-12 00:00:00 &#43;0000 UTC">12 November 2020</time><span class="px-2 text-primary-500">&middot;</span><span title="Reading time">5 mins</span>
    

    
    
  </div>

  
  


      </div>
      
    </header>
    <section class="flex flex-col max-w-full mt-0 prose dark:prose-invert lg:flex-row">
      
        <div class="order-first px-0 lg:order-last lg:max-w-xs lg:ps-8">
          <div class="toc pe-5 print:hidden lg:sticky lg:top-10">
            <details open class="-ms-5 mt-0 overflow-hidden rounded-lg ps-5">
  <summary
    class="-ms-5 block cursor-pointer bg-neutral-100 py-1 ps-5 text-lg font-semibold text-neutral-800 dark:bg-neutral-700 dark:text-neutral-100 lg:hidden"
  >
    Table of Contents
  </summary>
  <div class="-ms-5 border-s border-dotted border-neutral-300 py-2 ps-5 dark:border-neutral-600">
    <nav id="TableOfContents">
  <ul>
    <li><a href="#installing-openshift-service-mesh">Installing OpenShift Service Mesh</a></li>
    <li><a href="#keycloak">Keycloak</a>
      <ul>
        <li><a href="#deploying-red-hat-single-sign-on">Deploying Red Hat Single Sign-on</a></li>
        <li><a href="#deploying-bookinfo-example-application">Deploying Bookinfo example application</a></li>
      </ul>
    </li>
    <li><a href="#authentication">Authentication</a>
      <ul>
        <li><a href="#enabling-user-end-authentication">Enabling User-End Authentication</a></li>
      </ul>
    </li>
    <li><a href="#authorization">Authorization</a></li>
  </ul>
</nav>
  </div>
</details>

          </div>
        </div>
      
      <div class="min-w-0 min-h-0 max-w-prose grow">
        <p>In this article, I will share the setup for enabling Authentication and Authorization in OpenShift Service Mesh with Keycloak.</p>
<h2 id="installing-openshift-service-mesh" class="relative group">Installing OpenShift Service Mesh <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style="text-decoration-line: none !important;" href="#installing-openshift-service-mesh" aria-label="Anchor">#</a></span></h2><p>Follow the <a href="https://docs.OpenShift.com/container-platform/4.6/service_mesh/v1x/installing-ossm.html" target="_blank" rel="noreferrer">Installing Red Hat OpenShift Service Mesh</a> guide for setup</p>
<p>Enable the following configuration in your <code>ServiceMeshControlPlane</code> resource</p>
<ul>
<li>Strict mTLS across the mesh</li>
<li>Automatic istio route creation</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">maistra.io/v2</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ServiceMeshControlPlane</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="l">v1.1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">security</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">controlPlane</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">mtls</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">gateways</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">OpenShiftRoute</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">enabled</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span></code></pre></div><h2 id="keycloak" class="relative group">Keycloak <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style="text-decoration-line: none !important;" href="#keycloak" aria-label="Anchor">#</a></span></h2><p>Keycloak is an open-source identity and access management application that uses open protocols and is easily integrated with other providers. It is the open-source project base of Red Hat Single Sign-on</p>
<h3 id="deploying-red-hat-single-sign-on" class="relative group">Deploying Red Hat Single Sign-on <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style="text-decoration-line: none !important;" href="#deploying-red-hat-single-sign-on" aria-label="Anchor">#</a></span></h3><p>The easiest way to deploy SSO is from the operator hub.</p>
<p>




  
  
    
  
  
    <figure>
      <img
        class="mx-auto my-0 rounded-md"
        
          width="724"
          height="764"
          
            srcset="/blog/servicemesh-jwt-auth-authz-keycloack/sso-operator_hu6e26b3fe14a4b5f53abe5905cfc509da_70708_330x0_resize_box_3.png 330w,/blog/servicemesh-jwt-auth-authz-keycloack/sso-operator_hu6e26b3fe14a4b5f53abe5905cfc509da_70708_660x0_resize_box_3.png 660w,/blog/servicemesh-jwt-auth-authz-keycloack/sso-operator_hu6e26b3fe14a4b5f53abe5905cfc509da_70708_1024x0_resize_box_3.png 1024w,/blog/servicemesh-jwt-auth-authz-keycloack/sso-operator_hu6e26b3fe14a4b5f53abe5905cfc509da_70708_1320x0_resize_box_3.png 2x"
            src="/blog/servicemesh-jwt-auth-authz-keycloack/sso-operator_hu6e26b3fe14a4b5f53abe5905cfc509da_70708_660x0_resize_box_3.png"
          
        
        alt="sso-operator"
        
          loading="lazy"
        
      />
      
    </figure>
  
</p>
<p>Follow the <a href="https://labs.consol.de/development/2020/05/07/istio-and-keycloak.html" target="_blank" rel="noreferrer">Keycloak identity provider</a> article for adding a new security realm, client, role, user</p>
<h3 id="deploying-bookinfo-example-application" class="relative group">Deploying Bookinfo example application <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style="text-decoration-line: none !important;" href="#deploying-bookinfo-example-application" aria-label="Anchor">#</a></span></h3><p>Create a new namespace</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">oc new-project bookinfo
</span></span></code></pre></div><p>Edit the default Service Mesh Member Roll YAML and add bookinfo to the member&rsquo;s list</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">maistra.io/v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ServiceMeshMemberRoll</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">default</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">members</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">bookinfo</span><span class="w">
</span></span></span></code></pre></div><p>From the CLI, deploy the Bookinfo application in the <code>bookinfo</code> project by applying the bookinfo.yaml file</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">oc apply -n bookinfo -f https://raw.githubusercontent.com/Maistra/istio/maistra-2.0/samples/bookinfo/platform/kube/bookinfo.yaml
</span></span></code></pre></div><p>Create the ingress gateway by applying the bookinfo-gateway.yaml file</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">oc apply -n bookinfo -f https://raw.githubusercontent.com/Maistra/istio/maistra-2.0/samples/bookinfo/networking/bookinfo-gateway.yaml
</span></span></code></pre></div><p>Set the value for the <code>GATEWAY_URL</code> parameter</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">oc get routes -n istio-system <span class="p">|</span> grep bookinfo
</span></span><span class="line"><span class="cl"><span class="nb">export</span> <span class="nv">GATEWAY_URL</span><span class="o">=</span><span class="k">$(</span>oc -n istio-system get route bookinfo-gateway-pl2rw -o <span class="nv">jsonpath</span><span class="o">=</span><span class="s1">&#39;{.spec.host}&#39;</span><span class="k">)</span>
</span></span></code></pre></div><p>Adding default destination rules</p>
<p>I have enabled global mutual TLS in the control plane, so I’ll deploy the destination rule with all mtls</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">oc apply -n bookinfo -f https://raw.githubusercontent.com/Maistra/istio/maistra-2.0/samples/bookinfo/networking/destination-rule-all-mtls.yaml
</span></span></code></pre></div><p>Verifying the Bookinfo installation</p>
<p>Run the following command to confirm that the Bookinfo application is up and running</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">curl -o /dev/null -s -w <span class="s2">&#34;%{http_code}\n&#34;</span> http://<span class="nv">$GATEWAY_URL</span>/productpage
</span></span></code></pre></div><h2 id="authentication" class="relative group">Authentication <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style="text-decoration-line: none !important;" href="#authentication" aria-label="Anchor">#</a></span></h2><h3 id="enabling-user-end-authentication" class="relative group">Enabling User-End Authentication <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style="text-decoration-line: none !important;" href="#enabling-user-end-authentication" aria-label="Anchor">#</a></span></h3><p>Now it is time to enable end-user authentication.</p>
<p>The first thing you need to do is validate that it is possible to communicate between all services without authentication.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">curl -k -o /dev/null -w <span class="s2">&#34;%{http_code}&#34;</span> http://<span class="nv">$GATEWAY_URL</span>/productpage
</span></span><span class="line"><span class="cl"><span class="m">200</span>
</span></span></code></pre></div><p>You can create the end-user authentication policy.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">cat <span class="s">&lt;&lt;EOF | oc apply -n bookinfo -f -
</span></span></span><span class="line"><span class="cl"><span class="s">apiVersion: authentication.istio.io/v1alpha1
</span></span></span><span class="line"><span class="cl"><span class="s">kind: Policy
</span></span></span><span class="line"><span class="cl"><span class="s">metadata:
</span></span></span><span class="line"><span class="cl"><span class="s">  name: &#34;productpage-jwt&#34;
</span></span></span><span class="line"><span class="cl"><span class="s">  namespace: &#34;bookinfo&#34;
</span></span></span><span class="line"><span class="cl"><span class="s">spec:
</span></span></span><span class="line"><span class="cl"><span class="s">  targets:
</span></span></span><span class="line"><span class="cl"><span class="s">    - name: productpage
</span></span></span><span class="line"><span class="cl"><span class="s">  peers:
</span></span></span><span class="line"><span class="cl"><span class="s">    - mtls: {}
</span></span></span><span class="line"><span class="cl"><span class="s">  origins:
</span></span></span><span class="line"><span class="cl"><span class="s">    - jwt:
</span></span></span><span class="line"><span class="cl"><span class="s">        issuer: &#34;https://keycloak-sso.apps.amp01.lab.amp.aapaws/auth/realms/istio&#34;
</span></span></span><span class="line"><span class="cl"><span class="s">        jwksUri: &#34;https://keycloak-sso.apps.amp01.lab.amp.aapaws/auth/realms/istio/protocol/openid-connect/certs&#34;
</span></span></span><span class="line"><span class="cl"><span class="s">        audiences:
</span></span></span><span class="line"><span class="cl"><span class="s">          - customer
</span></span></span><span class="line"><span class="cl"><span class="s">        triggerRules:
</span></span></span><span class="line"><span class="cl"><span class="s">          - excludedPaths:
</span></span></span><span class="line"><span class="cl"><span class="s">              - prefix: /healthz
</span></span></span><span class="line"><span class="cl"><span class="s">  principalBinding: USE_ORIGIN
</span></span></span><span class="line"><span class="cl"><span class="s">EOF</span>
</span></span></code></pre></div><p><strong>NOTE</strong>: If you see <code>Origin authentication failed.</code> after passing the correct access token and URL. Verify your istio-pilot pods for any <code>x509: certificate signed by unknown authority</code>; if that is the case, follow this <a href="https://labs.consol.de/development/2020/05/07/debugging-istio.html" target="_blank" rel="noreferrer">workaround</a></p>
<p>Then let’s rerun the curl.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">curl -k http://<span class="nv">$GATEWAY_URL</span>/productpage
</span></span></code></pre></div><p>And you will see something like</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">Origin authentication failed.
</span></span></code></pre></div><p>Set the value for the <code>TOKEN</code> parameter from keyclock</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="nb">export</span> <span class="nv">TOKEN</span><span class="o">=</span><span class="k">$(</span>curl -sk --data <span class="s2">&#34;username=demo&amp;password=demo&amp;grant_type=password&amp;client_id=istio&#34;</span> https://keycloak-sso.apps.amp01.lab.amp.aapaws/auth/realms/istio/protocol/openid-connect/token <span class="p">|</span> jq <span class="s2">&#34;.access_token&#34;</span><span class="k">)</span>
</span></span></code></pre></div><p>Then let’s rerun the curl, this time with the token.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">curl -k -o /dev/null -w <span class="s2">&#34;%{http_code}&#34;</span> -H <span class="s2">&#34;Authorization: Bearer </span><span class="nv">$TOKEN</span><span class="s2">&#34;</span> http://<span class="nv">$GATEWAY_URL</span>/productpage
</span></span><span class="line"><span class="cl"><span class="m">200</span>
</span></span></code></pre></div><h2 id="authorization" class="relative group">Authorization <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style="text-decoration-line: none !important;" href="#authorization" aria-label="Anchor">#</a></span></h2><p>Create a deny-all policy in the namespace. The policy doesn’t have a selector field, which applies to every workload in the namespace. The <code>spec: field</code> in the policy has the empty value {}, this means that no traffic is permitted, effectively denying all requests</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ cat <span class="s">&lt;&lt;EOF | oc apply -n bookinfo -f -
</span></span></span><span class="line"><span class="cl"><span class="s">apiVersion: security.istio.io/v1beta1
</span></span></span><span class="line"><span class="cl"><span class="s">kind: AuthorizationPolicy
</span></span></span><span class="line"><span class="cl"><span class="s">metadata:
</span></span></span><span class="line"><span class="cl"><span class="s">  name: deny-all
</span></span></span><span class="line"><span class="cl"><span class="s">spec:
</span></span></span><span class="line"><span class="cl"><span class="s">  {}
</span></span></span><span class="line"><span class="cl"><span class="s">EOF</span>
</span></span></code></pre></div><p>Once the policy takes effect, verify that mesh rejected the curl connection to the workload.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ curl -k -H <span class="s2">&#34;Authorization: Bearer </span><span class="nv">$TOKEN</span><span class="s2">&#34;</span> http://<span class="nv">$GATEWAY_URL</span>/productpage
</span></span><span class="line"><span class="cl">RBAC: access denied
</span></span></code></pre></div><p>To give read access to the product page workload, create the policy that applies to the workload with label app: product page and allows users with roles customer to access it with all method.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ cat <span class="s">&lt;&lt;EOF | oc apply -n bookinfo -f -
</span></span></span><span class="line"><span class="cl"><span class="s">apiVersion: security.istio.io/v1beta1
</span></span></span><span class="line"><span class="cl"><span class="s">kind: AuthorizationPolicy
</span></span></span><span class="line"><span class="cl"><span class="s">metadata:
</span></span></span><span class="line"><span class="cl"><span class="s">  name: &#34;productpage-authz&#34;
</span></span></span><span class="line"><span class="cl"><span class="s">  namespace: &#34;bookinfo&#34;
</span></span></span><span class="line"><span class="cl"><span class="s">spec:
</span></span></span><span class="line"><span class="cl"><span class="s">  selector:
</span></span></span><span class="line"><span class="cl"><span class="s">    matchLabels:
</span></span></span><span class="line"><span class="cl"><span class="s">      app: productpage
</span></span></span><span class="line"><span class="cl"><span class="s">  rules:
</span></span></span><span class="line"><span class="cl"><span class="s">    - to:
</span></span></span><span class="line"><span class="cl"><span class="s">        - operation:
</span></span></span><span class="line"><span class="cl"><span class="s">            methods: [&#34;*&#34;]
</span></span></span><span class="line"><span class="cl"><span class="s">      when:
</span></span></span><span class="line"><span class="cl"><span class="s">        - key: request.auth.claims[roles]
</span></span></span><span class="line"><span class="cl"><span class="s">          values: [&#34;customer&#34;]
</span></span></span><span class="line"><span class="cl"><span class="s">EOF</span>
</span></span></code></pre></div><p>Wait for the newly defined policy to take effect.</p>
<p>After the policy takes effect, verify the connection to the httpbin workload succeeds.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">curl -k  -o /dev/null -w <span class="s2">&#34;%{http_code}&#34;</span> -H <span class="s2">&#34;Authorization: Bearer </span><span class="nv">$TOKEN</span><span class="s2">&#34;</span> http://<span class="nv">$GATEWAY_URL</span>/productpage
</span></span><span class="line"><span class="cl"><span class="m">200</span>
</span></span></code></pre></div><p>However, you can see the following errors on the page.</p>
<ul>
<li>Error fetching product details</li>
<li>Error fetching product reviews on the page</li>
</ul>
<p>Run the following command to create the details-viewer policy to allow the productpage workload, which issues requests using the <code>cluster.local/ns/bookinfo/sa/bookinfo-productpage</code> service account, to access the details workload via GET methods.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">oc apply -f - <span class="s">&lt;&lt;EOF
</span></span></span><span class="line"><span class="cl"><span class="s">apiVersion: &#34;security.istio.io/v1beta1&#34;
</span></span></span><span class="line"><span class="cl"><span class="s">kind: &#34;AuthorizationPolicy&#34;
</span></span></span><span class="line"><span class="cl"><span class="s">metadata:
</span></span></span><span class="line"><span class="cl"><span class="s">  name: &#34;details-viewer&#34;
</span></span></span><span class="line"><span class="cl"><span class="s">  namespace: bookinfo
</span></span></span><span class="line"><span class="cl"><span class="s">spec:
</span></span></span><span class="line"><span class="cl"><span class="s">  selector:
</span></span></span><span class="line"><span class="cl"><span class="s">    matchLabels:
</span></span></span><span class="line"><span class="cl"><span class="s">      app: details
</span></span></span><span class="line"><span class="cl"><span class="s">  rules:
</span></span></span><span class="line"><span class="cl"><span class="s">  - from:
</span></span></span><span class="line"><span class="cl"><span class="s">    - source:
</span></span></span><span class="line"><span class="cl"><span class="s">        principals: [&#34;cluster.local/ns/bookinfo/sa/bookinfo-productpage&#34;]
</span></span></span><span class="line"><span class="cl"><span class="s">    to:
</span></span></span><span class="line"><span class="cl"><span class="s">    - operation:
</span></span></span><span class="line"><span class="cl"><span class="s">        methods: [&#34;GET&#34;]
</span></span></span><span class="line"><span class="cl"><span class="s">EOF</span>
</span></span></code></pre></div><p>Run the following command to create a policy reviews-viewer to allow the productpage workload, which issues requests using the <code>cluster.local/ns/bookinfo/sa/bookinfo-productpage</code> service account, to access the reviews workload through GET methods</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">oc apply -f - <span class="s">&lt;&lt;EOF
</span></span></span><span class="line"><span class="cl"><span class="s">apiVersion: &#34;security.istio.io/v1beta1&#34;
</span></span></span><span class="line"><span class="cl"><span class="s">kind: &#34;AuthorizationPolicy&#34;
</span></span></span><span class="line"><span class="cl"><span class="s">metadata:
</span></span></span><span class="line"><span class="cl"><span class="s">  name: &#34;reviews-viewer&#34;
</span></span></span><span class="line"><span class="cl"><span class="s">  namespace: bookinfo
</span></span></span><span class="line"><span class="cl"><span class="s">spec:
</span></span></span><span class="line"><span class="cl"><span class="s">  selector:
</span></span></span><span class="line"><span class="cl"><span class="s">    matchLabels:
</span></span></span><span class="line"><span class="cl"><span class="s">      app: reviews
</span></span></span><span class="line"><span class="cl"><span class="s">  rules:
</span></span></span><span class="line"><span class="cl"><span class="s">  - from:
</span></span></span><span class="line"><span class="cl"><span class="s">    - source:
</span></span></span><span class="line"><span class="cl"><span class="s">        principals: [&#34;cluster.local/ns/bookinfo/sa/bookinfo-productpage&#34;]
</span></span></span><span class="line"><span class="cl"><span class="s">    to:
</span></span></span><span class="line"><span class="cl"><span class="s">    - operation:
</span></span></span><span class="line"><span class="cl"><span class="s">        methods: [&#34;GET&#34;]
</span></span></span><span class="line"><span class="cl"><span class="s">EOF</span>
</span></span></code></pre></div><p>Point your browser at the Bookinfo productpage (http://$GATEWAY_URL/productpage). Now, you should see the “Bookinfo Sample” page with “Book Details” on the lower left part and “Book Reviews” on the lower right part.</p>
<p>However, in the “Book Reviews” section, you&rsquo;ll see an error Rating service is currently unavailable. This error is because the reviews workload doesn’t permit access to the ratings workload. To fix this issue, you need to grant the reviews workload access to the ratings workload. Next, configure a policy to grant access to the reviews workload.</p>
<p>Run the following command to create the ratings-viewer policy to allow the reviews workload, which issues requests using the <code>cluster.local/ns/bookinfo/sa/bookinfo-reviews</code> service account,  to access the ratings workload through GET methods</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">oc apply -f - <span class="s">&lt;&lt;EOF
</span></span></span><span class="line"><span class="cl"><span class="s">apiVersion: &#34;security.istio.io/v1beta1&#34;
</span></span></span><span class="line"><span class="cl"><span class="s">kind: &#34;AuthorizationPolicy&#34;
</span></span></span><span class="line"><span class="cl"><span class="s">metadata:
</span></span></span><span class="line"><span class="cl"><span class="s">  name: &#34;ratings-viewer&#34;
</span></span></span><span class="line"><span class="cl"><span class="s">  namespace: bookinfo
</span></span></span><span class="line"><span class="cl"><span class="s">spec:
</span></span></span><span class="line"><span class="cl"><span class="s">  selector:
</span></span></span><span class="line"><span class="cl"><span class="s">    matchLabels:
</span></span></span><span class="line"><span class="cl"><span class="s">      app: ratings
</span></span></span><span class="line"><span class="cl"><span class="s">  rules:
</span></span></span><span class="line"><span class="cl"><span class="s">  - from:
</span></span></span><span class="line"><span class="cl"><span class="s">    - source:
</span></span></span><span class="line"><span class="cl"><span class="s">        principals: [&#34;cluster.local/ns/bookinfo/sa/bookinfo-reviews&#34;]
</span></span></span><span class="line"><span class="cl"><span class="s">    to:
</span></span></span><span class="line"><span class="cl"><span class="s">    - operation:
</span></span></span><span class="line"><span class="cl"><span class="s">        methods: [&#34;GET&#34;]
</span></span></span><span class="line"><span class="cl"><span class="s">EOF</span>
</span></span></code></pre></div><p>Point your browser at the Bookinfo productpage (http://$GATEWAY_URL/productpage). You should see the “black” and “red” ratings in the “Book Reviews” section.</p>

      </div>
    </section>
    <footer class="pt-8 max-w-prose print:hidden">
      
  <div class="flex">
    
      
      
        
        <img
          class="!mb-0 !mt-0 me-4 h-24 w-24 rounded-full"
          width="96"
          height="96"
          alt="Vikas Pogu"
          src="/img/myAvatar_hua882c21ea061ff9a690a266cf38baf1a_68117_192x192_fill_box_center_3.png"
          
            loading="lazy"
          
        />
      
    
    <div class="place-self-center">
      
        <div class="text-[0.6rem] uppercase leading-3 text-neutral-500 dark:text-neutral-400">
          Author
        </div>
        <div class="font-semibold leading-6 text-neutral-800 dark:text-neutral-300">
          Vikas Pogu
        </div>
      
      
        <div class="text-sm text-neutral-700 dark:text-neutral-400">Your guide to the techverse! By day, I&rsquo;m conquering code. Join me for tech hacks, and the occasional tech tale. Let&rsquo;s geek out together! 🚀💻 #TechEnthusiast #BloggerLife</div>
      
      <div class="text-2xl sm:text-lg">
</div>
    </div>
  </div>


      

      
  
    
    
    
    <div class="pt-8">
      <hr class="border-dotted border-neutral-300 dark:border-neutral-600" />
      <div class="flex justify-between pt-3">
        <span>
          
            <a class="group flex" href="/blog/loki-rsyslog-k3s/">
              <span
                class="me-2 text-neutral-700 transition-transform group-hover:-translate-x-[2px] group-hover:text-primary-600 dark:text-neutral dark:group-hover:text-primary-400"
                ><span class="ltr:inline rtl:hidden">&larr;</span
                ><span class="ltr:hidden rtl:inline">&rarr;</span></span
              >
              <span class="flex flex-col">
                <span
                  class="mt-[0.1rem] leading-6 group-hover:underline group-hover:decoration-primary-500"
                  >Syslog with Loki Promtail</span
                >
                <span class="mt-[0.1rem] text-xs text-neutral-500 dark:text-neutral-400">
                  
                    <time datetime="2020-11-04 00:00:00 &#43;0000 UTC">4 November 2020</time>
                  
                </span>
              </span>
            </a>
          
        </span>
        <span>
          
            <a class="group flex text-right" href="/blog/boot-from-usb-through-grub-menu/">
              <span class="flex flex-col">
                <span
                  class="mt-[0.1rem] leading-6 group-hover:underline group-hover:decoration-primary-500"
                  >Boot from USB through grub menu</span
                >
                <span class="mt-[0.1rem] text-xs text-neutral-500 dark:text-neutral-400">
                  
                    <time datetime="2020-12-01 00:00:00 &#43;0000 UTC">1 December 2020</time>
                  
                </span>
              </span>
              <span
                class="ms-2 text-neutral-700 transition-transform group-hover:-translate-x-[2px] group-hover:text-primary-600 dark:text-neutral dark:group-hover:text-primary-400"
                ><span class="ltr:inline rtl:hidden">&rarr;</span
                ><span class="ltr:hidden rtl:inline">&larr;</span></span
              >
            </a>
          
        </span>
      </div>
    </div>
  


      
    </footer>
  </article>

        
          <div class="pointer-events-none absolute bottom-0 end-0 top-[100vh] w-12">
            <a
              href="#the-top"
              class="pointer-events-auto sticky top-[calc(100vh-5.5rem)] flex h-12 w-12 items-center justify-center rounded-full bg-neutral/50 text-xl text-neutral-700 backdrop-blur hover:text-primary-600 dark:bg-neutral-800/50 dark:text-neutral dark:hover:text-primary-400"
              aria-label="Scroll to top"
              title="Scroll to top"
            >
              &uarr;
            </a>
          </div>
        
      </main><footer class="py-10 print:hidden">
  
  
  <div class="flex items-center justify-between">
    <div>
      
      
        <p class="text-sm text-neutral-500 dark:text-neutral-400">
            &copy;
            2024
            Vikas Pogu
        </p>
      
      
      
        <p class="text-xs text-neutral-500 dark:text-neutral-400">
          
          
          Powered by <a class="hover:underline hover:decoration-primary-400 hover:text-primary-500"
            href="https://gohugo.io/" target="_blank" rel="noopener noreferrer">Hugo</a> &amp; <a class="hover:underline hover:decoration-primary-400 hover:text-primary-500" href="https://github.com/jpanther/congo" target="_blank" rel="noopener noreferrer">Congo</a>
        </p>
      
    </div>
    <div class="flex flex-row items-center">
      
      
      
      
        <div
          class="me-14 cursor-pointer text-sm text-neutral-700 hover:text-primary-600 dark:text-neutral dark:hover:text-primary-400"
        >
          <button id="appearance-switcher-0" type="button" aria-label="appearance switcher">
            <div
              class="flex items-center justify-center w-12 h-12 dark:hidden"
              title="Switch to dark appearance"
            >
              <span class="relative inline-block align-text-bottom px-1 icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M32 256c0-123.8 100.3-224 223.8-224c11.36 0 29.7 1.668 40.9 3.746c9.616 1.777 11.75 14.63 3.279 19.44C245 86.5 211.2 144.6 211.2 207.8c0 109.7 99.71 193 208.3 172.3c9.561-1.805 16.28 9.324 10.11 16.95C387.9 448.6 324.8 480 255.8 480C132.1 480 32 379.6 32 256z"/></svg>
</span>
            </div>
            <div
              class="items-center justify-center hidden w-12 h-12 dark:flex"
              title="Switch to light appearance"
            >
              <span class="relative inline-block align-text-bottom px-1 icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M256 159.1c-53.02 0-95.1 42.98-95.1 95.1S202.1 351.1 256 351.1s95.1-42.98 95.1-95.1S309 159.1 256 159.1zM509.3 347L446.1 255.1l63.15-91.01c6.332-9.125 1.104-21.74-9.826-23.72l-109-19.7l-19.7-109c-1.975-10.93-14.59-16.16-23.72-9.824L256 65.89L164.1 2.736c-9.125-6.332-21.74-1.107-23.72 9.824L121.6 121.6L12.56 141.3C1.633 143.2-3.596 155.9 2.736 164.1L65.89 256l-63.15 91.01c-6.332 9.125-1.105 21.74 9.824 23.72l109 19.7l19.7 109c1.975 10.93 14.59 16.16 23.72 9.824L256 446.1l91.01 63.15c9.127 6.334 21.75 1.107 23.72-9.822l19.7-109l109-19.7C510.4 368.8 515.6 356.1 509.3 347zM256 383.1c-70.69 0-127.1-57.31-127.1-127.1c0-70.69 57.31-127.1 127.1-127.1s127.1 57.3 127.1 127.1C383.1 326.7 326.7 383.1 256 383.1z"/></svg>
</span>
            </div>
          </button>
        </div>
      
    </div>
  </div>
  
  
</footer>

    </div>
  </body>
</html>
