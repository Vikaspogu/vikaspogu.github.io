<!DOCTYPE html>
<html
  lang="en"
  theme="light"
>
  <head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  


<link
  rel="preload"
  as="font"
  type="font/woff2"
  href="/fonts/roboto-slab-latin-400.woff2"
  crossorigin="anonymous"
/>
<link
  rel="prefetch"
  as="font"
  type="font/woff2"
  href="/fonts/roboto-slab-latin-700.woff2"
  crossorigin="anonymous"
/>


<link
  rel="preload"
  as="font"
  type="font/woff2"
  href="/fonts/fira-code-latin-300.woff2"
  crossorigin="anonymous"
/>
<link
  rel="preload"
  as="font"
  type="font/woff2"
  href="/fonts/fira-code-latin-400.woff2"
  crossorigin="anonymous"
/>
<link
  rel="prefetch"
  as="font"
  type="font/woff2"
  href="/fonts/fira-code-latin-700.woff2"
  crossorigin="anonymous"
/>

  
  
    <meta
      name="robots"
      content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1"
    />
  



<title>End User Auth and Authz with OpenShift Service Mesh and Keycloak</title>

<meta
  name="description"
  content="End User Authentication and Authorization with OpenShift Service Mesh and Keycloak"
/>

<link rel="canonical" href="https://vikaspogu.dev/blog/servicemesh-jwt-auth-authz-keycloack/" />



<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="End User Auth and Authz with OpenShift Service Mesh and Keycloak"/>
<meta name="twitter:description" content="End User Authentication and Authorization with OpenShift Service Mesh and Keycloak"/>

<meta property="og:title" content="End User Auth and Authz with OpenShift Service Mesh and Keycloak" />
<meta property="og:description" content="End User Authentication and Authorization with OpenShift Service Mesh and Keycloak" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://vikaspogu.dev/blog/servicemesh-jwt-auth-authz-keycloack/" /><meta property="article:section" content="blog" />
<meta property="article:published_time" content="2020-11-12T00:00:00+00:00" />
<meta property="article:modified_time" content="2020-11-12T00:00:00+00:00" />

<meta itemprop="name" content="End User Auth and Authz with OpenShift Service Mesh and Keycloak">
<meta itemprop="description" content="End User Authentication and Authorization with OpenShift Service Mesh and Keycloak"><meta itemprop="datePublished" content="2020-11-12T00:00:00+00:00" />
<meta itemprop="dateModified" content="2020-11-12T00:00:00+00:00" />
<meta itemprop="wordCount" content="986">
<meta itemprop="keywords" content="istio,service mesh,keycloak,jwt,authentication,authorization," />








  
  


  








  
  
  
  


<style>
   
  @font-face{font-display:swap;font-family:Roboto Slab;font-style:normal;font-weight:100;src:local("Roboto Slab Thin "),local("Roboto Slab-Thin"),url(/fonts/roboto-slab-latin-100.woff2) format("woff2"),url(/fonts/roboto-slab-latin-100.woff) format("woff")}@font-face{font-display:swap;font-family:Roboto Slab;font-style:normal;font-weight:200;src:local("Roboto Slab Extra Light "),local("Roboto Slab-Extra Light"),url(/fonts/roboto-slab-latin-200.woff2) format("woff2"),url(/fonts/roboto-slab-latin-200.woff) format("woff")}@font-face{font-display:swap;font-family:Roboto Slab;font-style:normal;font-weight:300;src:local("Roboto Slab Light "),local("Roboto Slab-Light"),url(/fonts/roboto-slab-latin-300.woff2) format("woff2"),url(/fonts/roboto-slab-latin-300.woff) format("woff")}@font-face{font-display:swap;font-family:Roboto Slab;font-style:normal;font-weight:400;src:local("Roboto Slab Regular "),local("Roboto Slab-Regular"),url(/fonts/roboto-slab-latin-400.woff2) format("woff2"),url(/fonts/roboto-slab-latin-400.woff) format("woff")}@font-face{font-display:swap;font-family:Roboto Slab;font-style:normal;font-weight:500;src:local("Roboto Slab Medium "),local("Roboto Slab-Medium"),url(/fonts/roboto-slab-latin-500.woff2) format("woff2"),url(/fonts/roboto-slab-latin-500.woff) format("woff")}@font-face{font-display:swap;font-family:Roboto Slab;font-style:normal;font-weight:600;src:local("Roboto Slab SemiBold "),local("Roboto Slab-SemiBold"),url(/fonts/roboto-slab-latin-600.woff2) format("woff2"),url(/fonts/roboto-slab-latin-600.woff) format("woff")}@font-face{font-display:swap;font-family:Roboto Slab;font-style:normal;font-weight:700;src:local("Roboto Slab Bold "),local("Roboto Slab-Bold"),url(/fonts/roboto-slab-latin-700.woff2) format("woff2"),url(/fonts/roboto-slab-latin-700.woff) format("woff")}@font-face{font-display:swap;font-family:Roboto Slab;font-style:normal;font-weight:800;src:local("Roboto Slab ExtraBold "),local("Roboto Slab-ExtraBold"),url(/fonts/roboto-slab-latin-800.woff2) format("woff2"),url(/fonts/roboto-slab-latin-800.woff) format("woff")}@font-face{font-display:swap;font-family:Roboto Slab;font-style:normal;font-weight:900;src:local("Roboto Slab Black "),local("Roboto Slab-Black"),url(/fonts/roboto-slab-latin-900.woff2) format("woff2"),url(/fonts/roboto-slab-latin-900.woff) format("woff")}@font-face{font-display:swap;font-family:Fira Code;font-style:normal;font-weight:300;src:local("Fira Code Light "),local("Fira Code-Light"),url(/fonts/fira-code-latin-300.woff2) format("woff2"),url(/fonts/fira-code-latin-300.woff) format("woff")}@font-face{font-display:swap;font-family:Fira Code;font-style:normal;font-weight:400;src:local("Fira Code Regular "),local("Fira Code-Regular"),url(/fonts/fira-code-latin-400.woff2) format("woff2"),url(/fonts/fira-code-latin-400.woff) format("woff")}@font-face{font-display:swap;font-family:Fira Code;font-style:normal;font-weight:500;src:local("Fira Code Medium "),local("Fira Code-Medium"),url(/fonts/fira-code-latin-500.woff2) format("woff2"),url(/fonts/fira-code-latin-500.woff) format("woff")}@font-face{font-display:swap;font-family:Fira Code;font-style:normal;font-weight:600;src:local("Fira Code SemiBold "),local("Fira Code-SemiBold"),url(/fonts/fira-code-latin-600.woff2) format("woff2"),url(/fonts/fira-code-latin-600.woff) format("woff")}@font-face{font-display:swap;font-family:Fira Code;font-style:normal;font-weight:700;src:local("Fira Code Bold "),local("Fira Code-Bold"),url(/fonts/fira-code-latin-700.woff2) format("woff2"),url(/fonts/fira-code-latin-700.woff) format("woff")}

/*! normalize.css v8.0.1 | MIT License | github.com/necolas/normalize.css */html{-webkit-text-size-adjust:100%;line-height:1.15}body{margin:0}main{display:block}h1{font-size:2em;margin:.67em 0}hr{box-sizing:content-box;height:0;overflow:visible}pre{font-family:monospace,monospace;font-size:1em}a{background-color:transparent}abbr[title]{border-bottom:none;text-decoration:underline;-webkit-text-decoration:underline dotted;text-decoration:underline dotted}b,strong{font-weight:bolder}code,kbd,samp{font-family:monospace,monospace;font-size:1em}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}img{border-style:none}button,input,optgroup,select,textarea{font-family:inherit;font-size:100%;line-height:1.15;margin:0}button,input{overflow:visible}button,select{text-transform:none}[type=button],[type=reset],[type=submit],button{-webkit-appearance:button}[type=button]::-moz-focus-inner,[type=reset]::-moz-focus-inner,[type=submit]::-moz-focus-inner,button::-moz-focus-inner{border-style:none;padding:0}[type=button]:-moz-focusring,[type=reset]:-moz-focusring,[type=submit]:-moz-focusring,button:-moz-focusring{outline:1px dotted ButtonText}fieldset{padding:.35em .75em .625em}legend{box-sizing:border-box;color:inherit;display:table;max-width:100%;padding:0;white-space:normal}progress{vertical-align:baseline}textarea{overflow:auto}[type=checkbox],[type=radio]{box-sizing:border-box;padding:0}[type=number]::-webkit-inner-spin-button,[type=number]::-webkit-outer-spin-button{height:auto}[type=search]{-webkit-appearance:textfield;outline-offset:-2px}[type=search]::-webkit-search-decoration{-webkit-appearance:none}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}details{display:block}summary{display:list-item}[hidden],template{display:none}:root[theme=light]{--bg:var(--bg0);--bg0:#fbf1c7;--bg0_h:#f9f5d7;--bg0_s:#f2e5bc;--bg1:#ebdbb2;--bg2:#d5c4a1;--bg3:#bdae93;--bg4:#a89984;--fg:var(--fg1);--fg0:#282828;--fg1:#3c3836;--fg2:#504945;--fg3:#665c54;--fg4:#7c6f64;--gray1:var(--fg4);--gray2:#928374;--red1:#cc241d;--red2:#9d0006;--green1:#98971a;--green2:#797403;--yellow1:#d79921;--yellow2:#b57614;--blue1:#458588;--blue2:#076678;--purple1:#b16286;--purple2:#8f3f71;--aqua1:#689d6a;--aqua2:#427b58;--orange1:#d65d0e;--orange2:#af3a03}[theme=light]:root .light--hidden{display:none}:root[theme=dark]{--bg:var(--bg0);--bg0:#282828;--bg0_h:#1d2021;--bg0_s:#32302f;--bg1:#3c3836;--bg2:#504945;--bg3:#665c54;--bg4:#7c6f64;--fg:var(--fg1);--fg0:#fbf1c7;--fg1:#ebdbb2;--fg2:#d5c4a1;--fg3:#bdae93;--fg4:#a89984;--gray1:var(--fg4);--gray2:#928374;--red1:#cc241d;--red2:#fb4934;--green1:#98971a;--green2:#b8bb26;--yellow1:#d79921;--yellow2:#fabd2f;--blue1:#458588;--blue2:#83a598;--purple1:#b16286;--purple2:#d3869b;--aqua1:#689d6a;--aqua2:#8ec07c;--orange1:#d65d0e;--orange2:#fe8019}[theme=dark]:root .dark--hidden{display:none}:root{--primary:var(--blue1);--primary-alt:var(--blue2);--font-monospace:"Fira Code","Lucida Console",Monaco,monospace;--font-sans-serif:Verdana,Helvetica,sans-serif;--font-serif:"Roboto Slab",Georgia,serif}html{font-family:Roboto Slab,Georgia,serif;font-family:var(--font-serif);font-size:1rem;scroll-behavior:smooth}body{word-wrap:break-word;background:var(--bg);color:var(--fg);line-height:1.675}strong{letter-spacing:.35px}a{color:inherit;text-decoration:none}a.link--external:after{content:"\2009↗"}img{border:2px solid var(--bg1);height:auto;max-width:100%}figure{display:inline-block}figcaption{color:var(--fg3);font-family:Roboto Slab,Georgia,serif;font-family:var(--font-serif);font-size:.9rem}::-moz-selection{background:var(--bg4);color:var(--fg0)}::selection{background:var(--bg4);color:var(--fg0)}h1,h2,h3,h4{color:var(--fg0);font-family:Fira Code,Lucida Console,Monaco,monospace;font-family:var(--font-monospace);font-weight:300;line-height:1.4}h1 code,h2 code,h3 code,h4 code{font-size:1em}h2,h3,h4{border-bottom:1px solid var(--bg1)}h1,h2{font-weight:400}h1{font-size:1.875rem}h2{font-size:1.75rem}h3{font-size:1.625rem}@media (min-width:768px){h1{font-size:2.375rem}h2{font-size:2rem}h3{font-size:1.75rem}}h4{font-size:1.5rem}hr{background:var(--bg1);border:none;height:1px;margin:3rem auto;width:80%}blockquote,code,pre{border-radius:.2rem;padding:0 .2em}pre code{padding:0}blockquote,code,pre{background:var(--bg1)}code,pre{font-family:Fira Code,Lucida Console,Monaco,monospace;font-family:var(--font-monospace)}code code{background:var(--bg2)}blockquote,pre{padding:1rem}pre{background:var(--bg1)!important;overflow:auto}pre code{background:none}blockquote{border-left:5px solid var(--primary-alt);margin:.5rem 0}blockquote:not(.does-not-exist) code{background:var(--bg2)}blockquote:not(.does-not-exist) p:first-of-type{margin-top:0}blockquote:not(.does-not-exist) p:last-of-type{margin-bottom:0}pre::-webkit-scrollbar{height:.5rem;scrollbar-width:auto}pre::-webkit-scrollbar-track{background:var(--bg2);border-radius:.2rem}pre::-webkit-scrollbar-thumb{background:var(--bg4);border-radius:.2rem}.layout{display:grid;grid-template-areas:"header" "main" "footer";grid-template-rows:auto 1fr auto;height:100vh}main{align-items:start;display:grid;grid-area:main;grid-template-areas:"empty content sidebar";grid-template-columns:1fr minmax(0,650px) 4fr}header{background:var(--bg1);grid-area:header}footer{grid-area:footer}footer,main{margin:.5em 1.1em}.content{grid-area:content}.sidebar{display:none;flex-direction:column;grid-area:sidebar;margin-top:3rem;position:-webkit-sticky;position:sticky;top:2rem}@media (min-width:992px){.sidebar{display:flex}}header{display:grid;font-family:Fira Code,Lucida Console,Monaco,monospace;font-family:var(--font-monospace);font-size:1.125rem;grid-template-areas:"heading search nav theme-toggle";grid-template-columns:auto auto 1fr auto;padding:.75rem}.logo{color:var(--fg0);display:flex;font-weight:700;grid-area:heading}.logo:hover .logo__cursor{-webkit-animation:blink 1s infinite;animation:blink 1s infinite;opacity:1}.logo__chevron,.logo__cursor{margin-left:.5rem}.logo__cursor{opacity:0}.logo__text{display:none}@media (min-width:768px){.logo__text{display:block}}.search{display:flex;grid-area:search;margin:0 1rem}#search__text{background:var(--bg2);border:1px solid var(--bg2);border-radius:.2rem;caret-color:var(--fg);color:var(--fg);outline:none;padding:0 .5rem;width:100%}#search__text:hover{border-color:var(--bg3)}#search__text:focus{border-color:var(--bg4)}#search__text::-moz-placeholder{color:var(--fg3)}#search__text::placeholder{color:var(--fg3)}#search__text[type=search]::-webkit-search-cancel-button{-webkit-appearance:none;appearance:none}#search__suggestions{background:var(--bg);border-radius:.2rem;box-shadow:0 .5rem 1rem var(--bg1);font-family:Roboto Slab,Georgia,serif;font-family:var(--font-serif);left:0;margin-top:2rem;position:absolute;width:95vw;z-index:1000}@media (min-width:768px){.search{position:relative}#search__suggestions{width:60vw}}.search__suggestions--hidden{display:none}.search__suggestion-item{border-bottom:1px dashed var(--bg2);display:grid;grid-template-columns:1fr 2fr}.search__suggestion-item.focus-visible,.search__suggestion-item:focus,.search__suggestion-item:hover{background:var(--bg1);cursor:pointer;outline:none}.search__suggestion-item:focus,.search__suggestion-item:focus-visible,.search__suggestion-item:hover{background:var(--bg1);cursor:pointer;outline:none}.search__suggestion-item:last-child{border:none}.search__suggestion-description,.search__suggestion-title{margin:1rem 0;padding:0 1rem}.search__suggestion-title{font-weight:700}.search__suggestion-description{border-left:1px solid var(--bg2)}.search__no-results{padding:.75rem}.theme__toggle{align-items:center;background:none;border:none;color:var(--yellow1);cursor:pointer;display:flex;grid-area:theme-toggle;margin:0 1rem}.theme__toggle:hover{color:var(--yellow2)}.theme__toggle svg{height:28px;width:28px}nav#menu{align-items:center;display:flex;grid-area:nav;justify-content:flex-end}nav#menu .menu__item{color:var(--fg)}nav#menu .menu__item:hover{color:var(--fg3);cursor:pointer}nav#menu ul{list-style:none;margin:0;padding:0}nav#menu ul.menu--horizontal{align-items:center;display:none}nav#menu ul.menu--horizontal li{display:inline-block;margin:0 .75rem}@media (min-width:768px){nav#menu ul.menu--horizontal{display:flex}}nav#menu ul.menu--vertical{background:var(--fg0);bottom:0;margin:0;padding:3rem;position:fixed;right:0;top:0;transform:translate(100%);transition:transform .5s cubic-bezier(.9,0,.1,1);width:50%;z-index:10}nav#menu ul.menu--vertical .menu__item{color:var(--bg1)}nav#menu ul.menu--vertical .menu__item:hover{color:var(--bg4)}nav#menu .menu__burger{display:flex;height:24px;width:24px}nav#menu .menu__burger>*{position:absolute}nav#menu .menu__burger svg{height:inherit;width:inherit;z-index:20}nav#menu .menu__burger svg line{transition-duration:.5s;transition-property:stroke,opacity,transform;transition-timing-function:cubic-bezier(.9,0,.1,1)}nav#menu .menu__burger svg line:first-of-type{transform-origin:center 6px}nav#menu .menu__burger svg line:nth-of-type(2){transform-origin:center 12px}nav#menu .menu__burger svg line:nth-of-type(3){transform-origin:center 18px}nav#menu .menu__burger input{height:inherit;opacity:0;width:inherit;z-index:30}:is(nav#menu .menu__burger input:checked)~ul.menu--vertical{transform:none}:is(nav#menu .menu__burger input:checked)~svg{stroke:var(--bg1)}:is(nav#menu .menu__burger input:checked)~svg line:first-of-type{transform:translateY(6px) rotate(45deg)}:is(nav#menu .menu__burger input:checked)~svg line:nth-of-type(2){opacity:0;transform:scale(.2)}:is(nav#menu .menu__burger input:checked)~svg line:nth-of-type(3){transform:translateY(-6px) rotate(-45deg)}@media (min-width:768px){nav#menu .menu__burger{display:none}}

/*! Source: https://stackoverflow.com/a/36118384/1154965 */@-webkit-keyframes blink{50%{opacity:0}to{opacity:1}}@keyframes blink{50%{opacity:0}to{opacity:1}}.sidebar{font-family:Fira Code,Lucida Console,Monaco,monospace;font-family:var(--font-monospace);margin-left:auto;margin-right:auto;max-width:350px;padding-left:2.5rem}.sidebar svg{fill:var(--fg)}.jr-basics__image{background:var(--bg1);border:2px solid var(--bg2)}.jr-basics__profile a:hover{color:var(--fg3)}.jr-basics__profile a:hover svg{fill:var(--fg3)}.post{border-bottom:2px dotted var(--bg1);padding:2rem 0}.post figure,.post img:not(figure img){box-sizing:border-box;margin:.5rem 0}.post-content__read-more,.post-header{font-family:Fira Code,Lucida Console,Monaco,monospace;font-family:var(--font-monospace)}.post-content{margin:1.3rem 0}.post-content__read-more{margin-top:1.3rem}.post-content a,.post-content__read-more,.post-header a{color:var(--blue2);color:var(--primary-alt)}.post-content a:hover,.post-header a:hover{color:var(--blue1);color:var(--primary)}.post-tags{align-items:center;display:flex;flex-wrap:wrap;gap:.9rem;margin:1rem 0}.post-tag{font-size:.9rem;line-height:1}.post-tag:before{content:"#"}.post-heading__anchor{display:none}h1:hover .post-heading__anchor,h2:hover .post-heading__anchor,h3:hover .post-heading__anchor,h4:hover .post-heading__anchor{display:inline-block}.jr__item-meta{flex-direction:column}.jr-basics__image,.jr-basics__item,.jr-basics__profile-icon,.jr-basics__profile-item,.jr__item-meta{align-items:center;display:flex}.jr-basics__name,.jr-certificates__name,.jr-education__area,.jr-work__position{font-size:1.125rem;font-weight:700}.jr-basics__item{flex-direction:column;text-align:center}.jr-basics__item hr{margin:1.5rem auto}.jr-basics__image{border-radius:50%;height:250px;justify-content:center;overflow:hidden;width:250px}.jr-basics__label,.jr-basics__name{margin-top:.75rem}.jr-basics__profile svg{height:24px;width:24px}.jr-basics__profile,.jr-basics__profile-item{display:flex}.jr-basics__profile-item{display:flex;padding:.2rem}.jr-basics__profile--col{flex-direction:column}.jr-basics__profile-icon{padding:0 .75rem}.jr__item-meta{align-items:start;flex-flow:column;font-family:Fira Code,Lucida Console,Monaco,monospace;font-family:var(--font-monospace)}@media (min-width:768px){.jr__item-meta{align-items:center;flex-flow:row wrap}.jr-work__location,.jr__date-range{flex-grow:1;text-align:right}.jr-education__institution{flex-basis:100%}}.social-share{align-items:center;border-top:2px dotted var(--bg1);display:flex;flex-wrap:wrap;gap:.9rem;margin:3rem 0;padding-top:3rem}.social-share svg{fill:var(--fg);height:24px;width:24px}.social-share svg.icon-tabler{fill:none;stroke:var(--fg)}.social-share__item{background:var(--bg1);display:flex;padding:.5rem}
   
</style>

<link
  rel="preload"
  href="/css/non-critical.f67aefdd3191adb1c6e4b37bfbc0a254a8dc0816623d76a2d22160692d4abecf0ba11b28bbd577706969ec49af9d0775bedde87d55848b3276d6f261d689c960.css"
  as="style"
  onload="this.onload=null;this.rel='stylesheet'"
  integrity="sha512-9nrv3TGRrbHG5LN7+8CiVKjcCBZiPXai0iFgaS1Kvs8LoRsou9V3cGlp7EmvnQd1vt3ofVWEizJ21vJh1onJYA=="
/>

<link
  id="prism-dark"
  rel="prefetch"
  href="/prism-themes/prism-gruvbox-dark.min.54aecc64074623a4f9898544dcbdab9e804f1560ef0b38f4cf8e10fcaaf72264e798cb407c601aca6ecd833ec4eb93d66535581f18d45ba202cf848b70dbc332.css"
  as="style"
  onload="this.onload=null;this.rel='stylesheet'"
  integrity="sha512-VK7MZAdGI6T5iYVE3L2rnoBPFWDvCzj0z44Q/Kr3ImTnmMtAfGAaym7Ngz7E65PWZTVYHxjUW6ICz4SLcNvDMg=="
  disabled
/>

<link
  id="prism-light"
  rel="prefetch"
  href="/prism-themes/prism-gruvbox-light.min.42a221741efe997fcc94187c39d63c555560678789ac9ca856c74a5f0ddb2aa6c50d38b2ffbecc7a99038cbbd2efa99746e862267f781c559e0cfec10b88a5fc.css"
  as="style"
  onload="this.onload=null;this.rel='stylesheet'"
  integrity="sha512-QqIhdB7&#43;mX/MlBh8OdY8VVVgZ4eJrJyoVsdKXw3bKqbFDTiy/77MepkDjLvS76mXRuhiJn94HFWeDP7BC4il/A=="
  
/>

<noscript>
  
    <link
      rel="stylesheet"
      href="/prism-themes/prism-gruvbox-light.min.42a221741efe997fcc94187c39d63c555560678789ac9ca856c74a5f0ddb2aa6c50d38b2ffbecc7a99038cbbd2efa99746e862267f781c559e0cfec10b88a5fc.css"
      integrity="sha512-QqIhdB7&#43;mX/MlBh8OdY8VVVgZ4eJrJyoVsdKXw3bKqbFDTiy/77MepkDjLvS76mXRuhiJn94HFWeDP7BC4il/A=="
    />
  

  <link
    rel="stylesheet"
    href="/css/non-critical.f67aefdd3191adb1c6e4b37bfbc0a254a8dc0816623d76a2d22160692d4abecf0ba11b28bbd577706969ec49af9d0775bedde87d55848b3276d6f261d689c960.css"
    integrity="sha512-9nrv3TGRrbHG5LN7+8CiVKjcCBZiPXai0iFgaS1Kvs8LoRsou9V3cGlp7EmvnQd1vt3ofVWEizJ21vJh1onJYA=="
  />
</noscript>


  

  




<script>
  (()=>{function c(){if(localStorage&&localStorage.getItem("theme"))return localStorage.getItem("theme");if(window.matchMedia)return window.matchMedia("(prefers-color-scheme: light)").matches?"light":"dark"}function n(t){document.documentElement.setAttribute("theme",t);let e=document.getElementById("prism-dark"),i=document.getElementById("prism-light");e.toggleAttribute("disabled",t==="light"),i.toggleAttribute("disabled",t==="dark"),localStorage.setItem("theme",t)}var o=c();o&&n(o);function l(t){let e=t.currentTarget.classList.contains("light--hidden")?"light":"dark";n(e)}document.addEventListener("DOMContentLoaded",function(){document.querySelectorAll(".theme__toggle").forEach(e=>{e.addEventListener("click",l)})});})();

</script>


  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png" />
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png" />
<link rel="manifest" href="/site.webmanifest" />
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#282828" />
<meta name="msapplication-TileColor" content="#282828" />
<meta name="theme-color" content="#282828" />



  
  

</head>

  <body>
    <div class="layout">
      <header>
  <a
    class="logo"
    href="/"
  >
    
      <div class="logo__text">My blog...</div>
    
    <div class="logo__chevron">></div>
    <div class="logo__cursor">█</div>
  </a>

  <div class="search">
    <input
      id="search__text"
      type="search"
      placeholder="Search..."
      aria-label="Search"
      autocomplete="off"
    />
    <div id="search__suggestions" class="search__suggestions--hidden"></div>
  </div>

  <nav id="menu">
    <ul class="menu--horizontal">
      
        <li class="menu__item">
          <a href="/blog">Blog</a>
        </li>
      
        <li class="menu__item">
          <a href="/cv">CV</a>
        </li>
      
        <li class="menu__item">
          <a href="/about">About</a>
        </li>
      
        <li class="menu__item">
          <a href="/index.xml">RSS</a>
        </li>
      
    </ul>

    <div class="menu__burger">
      
      <input class="menu__item" type="checkbox" aria-label="Open main menu" />

      
<svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-menu-2" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <line x1="4" y1="6" x2="20" y2="6" />
  <line x1="4" y1="12" x2="20" y2="12" />
  <line x1="4" y1="18" x2="20" y2="18" />
</svg>







      <ul class="menu--vertical">
        
          <li>
            <a class="menu__item" href="/blog">Blog</a>
          </li>
        
          <li>
            <a class="menu__item" href="/cv">CV</a>
          </li>
        
          <li>
            <a class="menu__item" href="/about">About</a>
          </li>
        
          <li>
            <a class="menu__item" href="/index.xml">RSS</a>
          </li>
        
      </ul>
    </div>
  </nav>

  <button class="theme__toggle light--hidden" aria-label="Toggle light mode">
    
<svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-sun" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <circle cx="12" cy="12" r="4" />
  <path d="M3 12h1m8 -9v1m8 8h1m-9 8v1m-6.4 -15.4l.7 .7m12.1 -.7l-.7 .7m0 11.4l.7 .7m-12.1 -.7l-.7 .7" />
</svg>





  </button>

  <button class="theme__toggle dark--hidden" aria-label="Toggle dark mode">
    
<svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-moon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
</svg>





  </button>
</header>

      <main>
        <div class="content">
          
  <article class="post">
    <div class="post-header">
  <h1>
    <a href="/blog/servicemesh-jwt-auth-authz-keycloack/">End User Auth and Authz with OpenShift Service Mesh and Keycloak</a>
  </h1>

  <div class="post-meta">
    
      <span>2020-11-12</span>
    
    
    
    
    
    
      <div class="post-tags">
        
          <a
            class="post-tag"
            href="https://vikaspogu.dev/tags/istio"
          >istio</a>
        
          <a
            class="post-tag"
            href="https://vikaspogu.dev/tags/service-mesh"
          >service&#8209;mesh</a>
        
          <a
            class="post-tag"
            href="https://vikaspogu.dev/tags/keycloak"
          >keycloak</a>
        
          <a
            class="post-tag"
            href="https://vikaspogu.dev/tags/jwt"
          >jwt</a>
        
          <a
            class="post-tag"
            href="https://vikaspogu.dev/tags/authentication"
          >authentication</a>
        
          <a
            class="post-tag"
            href="https://vikaspogu.dev/tags/authorization"
          >authorization</a>
        
      </div>
    

    
  </div>
</div>

    <div class="post-content">
      <p>In this article, I will share the setup for enabling Authentication and Authorization in OpenShift Service Mesh with Keycloak.</p>
<h2 id="installing-openshift-service-mesh">
  Installing OpenShift Service Mesh
  <a href="#installing-openshift-service-mesh" class="post-heading__anchor" aria-hidden="true">#</a>
</h2>
<p>Follow the <a
  href="https://docs.OpenShift.com/container-platform/4.6/service_mesh/v1x/installing-ossm.html"
  
  
    class="link--external" target="_blank" rel="noreferrer"
  
>Installing Red Hat OpenShift Service Mesh</a> guide for setup</p>
<p>Enable the following configuration in your <code>ServiceMeshControlPlane</code> resource</p>
<ul>
<li>Strict mTLS across the mesh</li>
<li>Automatic istio route creation</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">maistra.io/v2</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">ServiceMeshControlPlane</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">version</span>: <span style="color:#ae81ff">v1.1</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">security</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">controlPlane</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">mtls</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">gateways</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">OpenShiftRoute</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">enabled</span>: <span style="color:#66d9ef">true</span>
</span></span></code></pre></div><h2 id="keycloak">
  Keycloak
  <a href="#keycloak" class="post-heading__anchor" aria-hidden="true">#</a>
</h2>
<p>Keycloak is an open-source identity and access management application that uses open protocols and is easily integrated with other providers. It is the open-source project base of Red Hat Single Sign-on</p>
<h3 id="deploying-red-hat-single-sign-on">
  Deploying Red Hat Single Sign-on
  <a href="#deploying-red-hat-single-sign-on" class="post-heading__anchor" aria-hidden="true">#</a>
</h3>
<p>The easiest way to deploy SSO is from the operator hub.</p>
<p>



  
  
  
  
  
  
    
    
    
    
    
    

    
    
    
      
        
        
        
          
          
          
        
      
    
      
        
        
        
          
          
          
        
      
    
      
        
        
        
          
          
          
        
      
    
      
        
        
        
          
          
          
        
      
    
      
        
        
        
          
          
          
        
      
    


    <picture>
      
        <source srcset="/blog/servicemesh-jwt-auth-authz-keycloack/sso-operator_hu6e26b3fe14a4b5f53abe5905cfc509da_70708_100x0_resize_q75_h2_box_3.webp 100w,/blog/servicemesh-jwt-auth-authz-keycloack/sso-operator_hu6e26b3fe14a4b5f53abe5905cfc509da_70708_200x0_resize_q75_h2_box_3.webp 200w,/blog/servicemesh-jwt-auth-authz-keycloack/sso-operator_hu6e26b3fe14a4b5f53abe5905cfc509da_70708_300x0_resize_q75_h2_box_3.webp 300w,/blog/servicemesh-jwt-auth-authz-keycloack/sso-operator_hu6e26b3fe14a4b5f53abe5905cfc509da_70708_400x0_resize_q75_h2_box_3.webp 400w,/blog/servicemesh-jwt-auth-authz-keycloack/sso-operator_hu6e26b3fe14a4b5f53abe5905cfc509da_70708_500x0_resize_q75_h2_box_3.webp 500w" />
      
      <img
        src="/blog/servicemesh-jwt-auth-authz-keycloack/sso-operator.png"
        srcset="/blog/servicemesh-jwt-auth-authz-keycloack/sso-operator_hu6e26b3fe14a4b5f53abe5905cfc509da_70708_100x0_resize_box_3.png 100w,/blog/servicemesh-jwt-auth-authz-keycloack/sso-operator_hu6e26b3fe14a4b5f53abe5905cfc509da_70708_200x0_resize_box_3.png 200w,/blog/servicemesh-jwt-auth-authz-keycloack/sso-operator_hu6e26b3fe14a4b5f53abe5905cfc509da_70708_300x0_resize_box_3.png 300w,/blog/servicemesh-jwt-auth-authz-keycloack/sso-operator_hu6e26b3fe14a4b5f53abe5905cfc509da_70708_400x0_resize_box_3.png 400w,/blog/servicemesh-jwt-auth-authz-keycloack/sso-operator_hu6e26b3fe14a4b5f53abe5905cfc509da_70708_500x0_resize_box_3.png 500w"
        alt="sso-operator"
        
        loading="lazy"
        width="724"
        height="764"
      />
    </picture>
  






</p>
<p>Follow the <a
  href="https://labs.consol.de/development/2020/05/07/istio-and-keycloak.html"
  
  
    class="link--external" target="_blank" rel="noreferrer"
  
>Keycloak identity provider</a> article for adding a new security realm, client, role, user</p>
<h3 id="deploying-bookinfo-example-application">
  Deploying Bookinfo example application
  <a href="#deploying-bookinfo-example-application" class="post-heading__anchor" aria-hidden="true">#</a>
</h3>
<p>Create a new namespace</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>oc new-project bookinfo
</span></span></code></pre></div><p>Edit the default Service Mesh Member Roll YAML and add bookinfo to the member&rsquo;s list</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">maistra.io/v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">ServiceMeshMemberRoll</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">default</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">members</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">bookinfo</span>
</span></span></code></pre></div><p>From the CLI, deploy the Bookinfo application in the <code>bookinfo</code> project by applying the bookinfo.yaml file</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>oc apply -n bookinfo -f https://raw.githubusercontent.com/Maistra/istio/maistra-2.0/samples/bookinfo/platform/kube/bookinfo.yaml
</span></span></code></pre></div><p>Create the ingress gateway by applying the bookinfo-gateway.yaml file</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>oc apply -n bookinfo -f https://raw.githubusercontent.com/Maistra/istio/maistra-2.0/samples/bookinfo/networking/bookinfo-gateway.yaml
</span></span></code></pre></div><p>Set the value for the <code>GATEWAY_URL</code> parameter</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>oc get routes -n istio-system | grep bookinfo
</span></span><span style="display:flex;"><span>export GATEWAY_URL<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>oc -n istio-system get route bookinfo-gateway-pl2rw -o jsonpath<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;{.spec.host}&#39;</span><span style="color:#66d9ef">)</span>
</span></span></code></pre></div><p>Adding default destination rules</p>
<p>I have enabled global mutual TLS in the control plane, so I’ll deploy the destination rule with all mtls</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>oc apply -n bookinfo -f https://raw.githubusercontent.com/Maistra/istio/maistra-2.0/samples/bookinfo/networking/destination-rule-all-mtls.yaml
</span></span></code></pre></div><p>Verifying the Bookinfo installation</p>
<p>Run the following command to confirm that the Bookinfo application is up and running</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>curl -o /dev/null -s -w <span style="color:#e6db74">&#34;%{http_code}\n&#34;</span> http://$GATEWAY_URL/productpage
</span></span></code></pre></div><h2 id="authentication">
  Authentication
  <a href="#authentication" class="post-heading__anchor" aria-hidden="true">#</a>
</h2>
<h3 id="enabling-user-end-authentication">
  Enabling User-End Authentication
  <a href="#enabling-user-end-authentication" class="post-heading__anchor" aria-hidden="true">#</a>
</h3>
<p>Now it is time to enable end-user authentication.</p>
<p>The first thing you need to do is validate that it is possible to communicate between all services without authentication.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>curl -k -o /dev/null -w <span style="color:#e6db74">&#34;%{http_code}&#34;</span> http://$GATEWAY_URL/productpage
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">200</span>
</span></span></code></pre></div><p>You can create the end-user authentication policy.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>cat <span style="color:#e6db74">&lt;&lt;EOF | oc apply -n bookinfo -f -
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">apiVersion: authentication.istio.io/v1alpha1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">kind: Policy
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">metadata:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  name: &#34;productpage-jwt&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  namespace: &#34;bookinfo&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">spec:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  targets:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    - name: productpage
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  peers:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    - mtls: {}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  origins:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    - jwt:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        issuer: &#34;https://keycloak-sso.apps.amp01.lab.amp.aapaws/auth/realms/istio&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        jwksUri: &#34;https://keycloak-sso.apps.amp01.lab.amp.aapaws/auth/realms/istio/protocol/openid-connect/certs&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        audiences:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          - customer
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        triggerRules:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          - excludedPaths:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">              - prefix: /healthz
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  principalBinding: USE_ORIGIN
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span></code></pre></div><p><strong>NOTE</strong>: If you see <code>Origin authentication failed.</code> after passing the correct access token and URL. Verify your istio-pilot pods for any <code>x509: certificate signed by unknown authority</code>; if that is the case, follow this <a
  href="https://labs.consol.de/development/2020/05/07/debugging-istio.html"
  
  
    class="link--external" target="_blank" rel="noreferrer"
  
>workaround</a></p>
<p>Then let’s rerun the curl.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>curl -k http://$GATEWAY_URL/productpage
</span></span></code></pre></div><p>And you will see something like</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>Origin authentication failed.
</span></span></code></pre></div><p>Set the value for the <code>TOKEN</code> parameter from keyclock</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>export TOKEN<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>curl -sk --data <span style="color:#e6db74">&#34;username=demo&amp;password=demo&amp;grant_type=password&amp;client_id=istio&#34;</span> https://keycloak-sso.apps.amp01.lab.amp.aapaws/auth/realms/istio/protocol/openid-connect/token | jq <span style="color:#e6db74">&#34;.access_token&#34;</span><span style="color:#66d9ef">)</span>
</span></span></code></pre></div><p>Then let’s rerun the curl, this time with the token.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>curl -k -o /dev/null -w <span style="color:#e6db74">&#34;%{http_code}&#34;</span> -H <span style="color:#e6db74">&#34;Authorization: Bearer </span>$TOKEN<span style="color:#e6db74">&#34;</span> http://$GATEWAY_URL/productpage
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">200</span>
</span></span></code></pre></div><h2 id="authorization">
  Authorization
  <a href="#authorization" class="post-heading__anchor" aria-hidden="true">#</a>
</h2>
<p>Create a deny-all policy in the namespace. The policy doesn’t have a selector field, which applies to every workload in the namespace. The <code>spec: field</code> in the policy has the empty value {}, this means that no traffic is permitted, effectively denying all requests</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ cat <span style="color:#e6db74">&lt;&lt;EOF | oc apply -n bookinfo -f -
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">apiVersion: security.istio.io/v1beta1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">kind: AuthorizationPolicy
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">metadata:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  name: deny-all
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">spec:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  {}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span></code></pre></div><p>Once the policy takes effect, verify that mesh rejected the curl connection to the workload.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ curl -k -H <span style="color:#e6db74">&#34;Authorization: Bearer </span>$TOKEN<span style="color:#e6db74">&#34;</span> http://$GATEWAY_URL/productpage
</span></span><span style="display:flex;"><span>RBAC: access denied
</span></span></code></pre></div><p>To give read access to the product page workload, create the policy that applies to the workload with label app: product page and allows users with roles customer to access it with all method.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ cat <span style="color:#e6db74">&lt;&lt;EOF | oc apply -n bookinfo -f -
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">apiVersion: security.istio.io/v1beta1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">kind: AuthorizationPolicy
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">metadata:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  name: &#34;productpage-authz&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  namespace: &#34;bookinfo&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">spec:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  selector:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    matchLabels:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      app: productpage
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  rules:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    - to:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        - operation:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            methods: [&#34;*&#34;]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      when:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        - key: request.auth.claims[roles]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          values: [&#34;customer&#34;]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span></code></pre></div><p>Wait for the newly defined policy to take effect.</p>
<p>After the policy takes effect, verify the connection to the httpbin workload succeeds.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>curl -k  -o /dev/null -w <span style="color:#e6db74">&#34;%{http_code}&#34;</span> -H <span style="color:#e6db74">&#34;Authorization: Bearer </span>$TOKEN<span style="color:#e6db74">&#34;</span> http://$GATEWAY_URL/productpage
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">200</span>
</span></span></code></pre></div><p>However, you can see the following errors on the page.</p>
<ul>
<li>Error fetching product details</li>
<li>Error fetching product reviews on the page</li>
</ul>
<p>Run the following command to create the details-viewer policy to allow the productpage workload, which issues requests using the <code>cluster.local/ns/bookinfo/sa/bookinfo-productpage</code> service account, to access the details workload via GET methods.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>oc apply -f - <span style="color:#e6db74">&lt;&lt;EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">apiVersion: &#34;security.istio.io/v1beta1&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">kind: &#34;AuthorizationPolicy&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">metadata:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  name: &#34;details-viewer&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  namespace: bookinfo
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">spec:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  selector:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    matchLabels:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      app: details
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  rules:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  - from:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    - source:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        principals: [&#34;cluster.local/ns/bookinfo/sa/bookinfo-productpage&#34;]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    to:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    - operation:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        methods: [&#34;GET&#34;]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span></code></pre></div><p>Run the following command to create a policy reviews-viewer to allow the productpage workload, which issues requests using the <code>cluster.local/ns/bookinfo/sa/bookinfo-productpage</code> service account, to access the reviews workload through GET methods</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>oc apply -f - <span style="color:#e6db74">&lt;&lt;EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">apiVersion: &#34;security.istio.io/v1beta1&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">kind: &#34;AuthorizationPolicy&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">metadata:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  name: &#34;reviews-viewer&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  namespace: bookinfo
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">spec:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  selector:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    matchLabels:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      app: reviews
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  rules:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  - from:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    - source:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        principals: [&#34;cluster.local/ns/bookinfo/sa/bookinfo-productpage&#34;]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    to:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    - operation:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        methods: [&#34;GET&#34;]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span></code></pre></div><p>Point your browser at the Bookinfo productpage (http://$GATEWAY_URL/productpage). Now, you should see the “Bookinfo Sample” page with “Book Details” on the lower left part and “Book Reviews” on the lower right part.</p>
<p>However, in the “Book Reviews” section, you&rsquo;ll see an error Rating service is currently unavailable. This error is because the reviews workload doesn’t permit access to the ratings workload. To fix this issue, you need to grant the reviews workload access to the ratings workload. Next, configure a policy to grant access to the reviews workload.</p>
<p>Run the following command to create the ratings-viewer policy to allow the reviews workload, which issues requests using the <code>cluster.local/ns/bookinfo/sa/bookinfo-reviews</code> service account,  to access the ratings workload through GET methods</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>oc apply -f - <span style="color:#e6db74">&lt;&lt;EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">apiVersion: &#34;security.istio.io/v1beta1&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">kind: &#34;AuthorizationPolicy&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">metadata:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  name: &#34;ratings-viewer&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  namespace: bookinfo
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">spec:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  selector:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    matchLabels:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      app: ratings
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  rules:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  - from:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    - source:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        principals: [&#34;cluster.local/ns/bookinfo/sa/bookinfo-reviews&#34;]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    to:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    - operation:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        methods: [&#34;GET&#34;]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span></code></pre></div><p>Point your browser at the Bookinfo productpage (http://$GATEWAY_URL/productpage). You should see the “black” and “red” ratings in the “Book Reviews” section.</p>

    </div>

    
      


  <div class="social-share">
    <strong class="social-share__heading">Share this post: </strong>
    
      
      
      
      <a
        class="social-share__item"
        href="https://www.linkedin.com/sharing/share-offsite/?url=https%3A%2F%2Fvikaspogu.dev%2Fblog%2Fservicemesh-jwt-auth-authz-keycloack%2F"
        target="_blank"
        rel="noreferrer"
      >
        
<svg role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>LinkedIn</title><path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144 0-2.063-.926-2.063-2.065 0-1.138.92-2.063 2.063-2.063 1.14 0 2.064.925 2.064 2.063 0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"/></svg>


      </a>
    
      
      
      
      <a
        class="social-share__item"
        href="https://reddit.com/submit?url=https%3A%2F%2Fvikaspogu.dev%2Fblog%2Fservicemesh-jwt-auth-authz-keycloack%2F&amp;title=End&#43;User&#43;Auth&#43;and&#43;Authz&#43;with&#43;OpenShift&#43;Service&#43;Mesh&#43;and&#43;Keycloak"
        target="_blank"
        rel="noreferrer"
      >
        
<svg role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>Reddit</title><path d="M12 0A12 12 0 0 0 0 12a12 12 0 0 0 12 12 12 12 0 0 0 12-12A12 12 0 0 0 12 0zm5.01 4.744c.688 0 1.25.561 1.25 1.249a1.25 1.25 0 0 1-2.498.056l-2.597-.547-.8 3.747c1.824.07 3.48.632 4.674 1.488.308-.309.73-.491 1.207-.491.968 0 1.754.786 1.754 1.754 0 .716-.435 1.333-1.01 1.614a3.111 3.111 0 0 1 .042.52c0 2.694-3.13 4.87-7.004 4.87-3.874 0-7.004-2.176-7.004-4.87 0-.183.015-.366.043-.534A1.748 1.748 0 0 1 4.028 12c0-.968.786-1.754 1.754-1.754.463 0 .898.196 1.207.49 1.207-.883 2.878-1.43 4.744-1.487l.885-4.182a.342.342 0 0 1 .14-.197.35.35 0 0 1 .238-.042l2.906.617a1.214 1.214 0 0 1 1.108-.701zM9.25 12C8.561 12 8 12.562 8 13.25c0 .687.561 1.248 1.25 1.248.687 0 1.248-.561 1.248-1.249 0-.688-.561-1.249-1.249-1.249zm5.5 0c-.687 0-1.248.561-1.248 1.25 0 .687.561 1.248 1.249 1.248.688 0 1.249-.561 1.249-1.249 0-.687-.562-1.249-1.25-1.249zm-5.466 3.99a.327.327 0 0 0-.231.094.33.33 0 0 0 0 .463c.842.842 2.484.913 2.961.913.477 0 2.105-.056 2.961-.913a.361.361 0 0 0 .029-.463.33.33 0 0 0-.464 0c-.547.533-1.684.73-2.512.73-.828 0-1.979-.196-2.512-.73a.326.326 0 0 0-.232-.095z"/></svg>


      </a>
    
      
      
      
      <a
        class="social-share__item"
        href="mailto:?subject=End&#43;User&#43;Auth&#43;and&#43;Authz&#43;with&#43;OpenShift&#43;Service&#43;Mesh&#43;and&#43;Keycloak&amp;body=https%3A%2F%2Fvikaspogu.dev%2Fblog%2Fservicemesh-jwt-auth-authz-keycloack%2F"
        target="_blank"
        rel="noreferrer"
      >
        
<svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-mail" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <rect x="3" y="5" width="18" height="14" rx="2" />
  <polyline points="3 7 12 13 21 7" />
</svg>





      </a>
    
  </div>


    

    
  </article>

        </div>
        <div class="sidebar">
  

  
  
    <aside class="bio">
      

  <section class="jr__item jr-basics__item">
    
  <div class="jr-basics__image">
    <img
      src="https://raw.githubusercontent.com/Vikaspogu/blog/master/static/images/myAvatar.png"
      alt="Picture of Vikas Pogu"
      width="250"
      height="250"
    />
  </div>



    
      <div class="jr-basics__name">Vikas Pogu</div>
    

    
      <div class="jr-basics__label">Senior Consultant at Red Hat</div>
    

    
      <div class="jr-basics__email">vikaspoguadf@gmail.com</div>
    

    

    

    

    
      

      

      
        <div class="jr-basics__location-city">Rochester, Minnesota.</div>
      

      

      
    

    
      <hr />
      <div class="jr-basics__profile jr-basics__profile--col">
        
          

<a href="https://github.com/Vikaspogu">

<div class="jr-basics__profile-item">
  <div class="jr-basics__profile-icon">
    
    <svg role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>GitHub</title><path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"/></svg>
  </div>

  
    <div class="jr-basics__profile-username">vikaspogu</div>
  
</div>


</a>

        
      </div>
    

    
  </section>


    </aside>
  
</div>

      </main>
      <footer>
  <div class="copyright">
    
      Copyright © 2021
    
  </div>
</footer>



  







  
  


<script
  type="text/javascript"
  src="/js/main.208ad98be109e8d42030d15d513c04bf8a3e4238d1e8f885c1062328ea2fc9b389dd1af11c86a87ade934b3acecf72a0a4bdc4d50dfe07765ac0df1b40e3db0e.js"
  integrity="sha512-IIrZi&#43;EJ6NQgMNFdUTwEv4o&#43;QjjR6PiFwQYjKOovybOJ3RrxHIaoet6TSzrOz3KgpL3E1Q3&#43;B3ZawN8bQOPbDg==">
</script>

<script
  type="text/javascript"
  src="/js/flexsearch.a6e3c6b648da5bb991a12f99f617372fbd4e51cb8822f2c5c853a3af3511e7164581305c49a58e5739e83a689c39b0a0871a382c509ba147a0d542ca3bf7741e.js"
  integrity="sha512-puPGtkjaW7mRoS&#43;Z9hc3L71OUcuIIvLFyFOjrzUR5xZFgTBcSaWOVznoOmicObCghxo4LFCboUeg1ULKO/d0Hg==">
</script>





    </div>
  </body>
</html>
